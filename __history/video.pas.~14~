unit video;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Menus, ExtCtrls, ComCtrls, StdCtrls, Buttons,
  DirectShow9, math, ActiveX, Vcl.Imaging.pngimage;

type
  TPlayerMode = (Stop, Play, Paused); // ðåæèì âîñïðîèçâåäåíèÿ
  Tvideo_form = class(TForm)
    main_panel: TPanel;
    Splitter1: TSplitter;
    Panel1: TPanel;
    ListBox1: TListBox;
    GroupBox1: TGroupBox;
    Panel2: TPanel;
    Label4: TLabel;
    Image1: TImage;
    Image2: TImage;
    Image3: TImage;
    Image4: TImage;
    Image5: TImage;
    Image6: TImage;
    TrackBar1: TTrackBar;
    ListBox2: TListBox;
    OpenDialog1: TOpenDialog;
    tim: TTimer;
    Timer2: TTimer;
    PopupMenu1: TPopupMenu;
    N3: TMenuItem;
    N2: TMenuItem;
    N1: TMenuItem;
    Panel4: TPanel;
    ProgressBar1: TProgressBar;
    Panel3: TPanel;
    Label2: TLabel;
    Label3: TLabel;
    Label5: TLabel;
    Image7: TImage;
    Timer_form: TTimer;
    Label1: TLabel;
    Label6: TLabel;
    Image8: TImage;
    Image9: TImage;
    Image10: TImage;
    Image11: TImage;
    Image12: TImage;
    Image13: TImage;
    Image14: TImage;
    Image15: TImage;
    procedure Initializ;
    procedure Player;
    procedure AddPlayList;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure SpeedButton3Click(Sender: TObject);
    procedure timTimer(Sender: TObject);
    procedure ProgressBar1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Panel1Resize(Sender: TObject);
    procedure Panel1DblClick(Sender: TObject);
    procedure Panel1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Timer2Timer(Sender: TObject);
    procedure N2Click(Sender: TObject);
    procedure ListBox2DblClick(Sender: TObject);
    procedure ListBox2MouseActivate(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y, HitTest: Integer;
      var MouseActivate: TMouseActivate);
    procedure ListBox2Click(Sender: TObject);
    procedure SpeedButton5Click(Sender: TObject);
    procedure SpeedButton4Click(Sender: TObject);
    //procedure CheckBox1Click(Sender: TObject);
    procedure SpeedButton6Click(Sender: TObject);
    procedure N1Click(Sender: TObject);
    procedure N3Click(Sender: TObject);
    procedure Timer_formTimer(Sender: TObject);
    procedure Close_labelClick(Sender: TObject);
    procedure Image8Click(Sender: TObject);
    procedure Image9Click(Sender: TObject);
    procedure FormMouseWheelDown(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure FormMouseWheelUp(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure Image7MouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure Image7MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure Image10Click(Sender: TObject);
    procedure CreateParams(var Params: TCreateParams); override;
    procedure Image11Click(Sender: TObject);
    procedure Image12Click(Sender: TObject);
    procedure Image13Click(Sender: TObject);
    procedure Image14Click(Sender: TObject);
    procedure Image15Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
  { Private declarations }
  //ïðîöåäóðà îáðàáîòêè ñîîáùåíèé îò êëàâèàòóðû
  Procedure WMKeyDown(Var Msg:TWMKeyDown); Message WM_KeyDown;
  public
    { Public declarations }
    nx,ny:integer;
  end;

var
  video_form: Tvideo_form;
  hr: HRESULT = 1; //çàäàåì íà÷àëüíîå çíà÷åíèå ëîæü
  pCurrent, pDuration: Double;// Òåêóæåå ïîëîæåíèå è äëèòåëüíîñòü ôèëüìà
  Mode: TPlayerMode; // ðåæèì âîñïðîèçâåäåíèÿ
  Rate: Double;// íîðìàëüíàÿ ñêîðîñòü âîñïðîèçâåäåíèÿ
  FullScreen: boolean = false; //èíäèêàòîð ïåðåõîäà â ïîëíîýêðàííûé ðåæèì
  i: integer = 0;// ñ÷åò÷èê çàãðóæåííûõ ôàéëîâ
  FileName: string;//èìÿ ôàéëà
  xn, yn : integer; //äëÿ õðàíåíèÿ êîîðäèíàò ìûøè
  mouse: tmouse; //êîîðäèíàòû ìûøè

  //èíòåðôåéñû äëÿ ïîñòðîåíèÿ è óïðàâëåíèÿ ãðàôîì
  pGraphBuilder        : IGraphBuilder         = nil; //ñàì ãðàô
  pMediaControl        : IMediaControl         = nil; //óïðàâëåíèå ãðàôîì
  pMediaEvent          : IMediaEvent           = nil; //îáðàáîò÷èê ñîáûòèé
  pVideoWindow         : IVideoWindow          = nil; //çàäàåò îêíî äëÿ âûâîäà
  pMediaPosition       : IMediaPosition        = nil; //ïîçèöèÿ ïðîèãðûâàíèÿ
  pBasicAudio          : IBasicAudio           = nil; //óïðàâëåíèå çâóêîì

implementation
uses text_editor, Open_space, photo_view_, LW9, paint;

{$R *.dfm}

procedure Tvideo_form.Image10Click(Sender: TObject);
begin
   if (not Assigned(Form1)) then   // ïðîâåðêà ñóùåñòâîâàíèÿ Ôîðìû (åñëè íåò, òî
       Form1:=TForm1.Create(Self);    // ñîçäàíèå Ôîðìû)
   Form1.Show; // (èëè Form2.ShowModal) ïîêàç Ôîðìû
end;

procedure Tvideo_form.Image11Click(Sender: TObject);
begin
  Form2.Show;
end;

procedure Tvideo_form.Image12Click(Sender: TObject);
begin
  if (not Assigned(photo_view)) then   // ïðîâåðêà ñóùåñòâîâàíèÿ Ôîðìû (åñëè íåò, òî
       photo_view:=Tphoto_view.Create(Self);    // ñîçäàíèå Ôîðìû)
   photo_view.Show; // (èëè Form2.ShowModal) ïîêàç Ôîðìû
end;

procedure Tvideo_form.Image13Click(Sender: TObject);
begin
  if (not Assigned(dbform)) then   // ïðîâåðêà ñóùåñòâîâàíèÿ Ôîðìû (åñëè íåò, òî
       dbform:=Tdbform.Create(self); //self   // ñîçäàíèå Ôîðìû)
   dbform.Show; // (èëè Form2.ShowModal) ïîêàç Ôîðìû
end;

procedure Tvideo_form.Image14Click(Sender: TObject);
begin
  video_form.Close;
end;

procedure Tvideo_form.Image15Click(Sender: TObject);
begin
  if (not Assigned(paintform)) then   // ïðîâåðêà ñóùåñòâîâàíèÿ Ôîðìû (åñëè íåò, òî
       paintform:=Tpaintform.Create(Self);    // ñîçäàíèå Ôîðìû)
   paintform.Show; // (èëè Form2.ShowModal) ïîêàç Ôîðìû
end;

procedure Tvideo_form.CreateParams(var Params: TCreateParams);
begin
  inherited CreateParams(Params);
  Params.WndParent:= GetDesktopWindow; // äî÷åðíÿÿ ôîðìà ðàáî÷åãî ñòîëà
end;

procedure Tvideo_form.Image7MouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
  nx:=x;ny:=y;
end;

procedure Tvideo_form.Image7MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if ssleft in shift then begin
    video_form.Top:= video_form.Top+y-ny;
    video_form.Left:= video_form.Left+x-nx;
  end;
end;

procedure Tvideo_form.Image8Click(Sender: TObject);
begin
  if mode=play then
  begin
   pMediaControl.Stop;
   mode:=Stop;//óñòàíàâëèâàåì playmode -> ñòîï
   //çàäàåì íà÷àëüíîå ïîëîæåíèå ïðîèãðàâàíèÿ
   pMediaPosition.put_CurrentPosition(0);
  end;
  video_form.Close;
end;

procedure Tvideo_form.Image9Click(Sender: TObject);
begin
  video_form.WindowState:=wsMinimized;
end;

procedure Tvideo_form.Initializ;
//ïðîöåäóðà ïîñòðîåíèÿ ãðàôà
begin
//îñâîáîæäàåì ïîäêëþ÷åííûå èíòåðôåéñû
  if Assigned(pMediaPosition) then pMediaPosition := nil;
  if Assigned(pBasicAudio) then pBasicAudio  := nil;
  if Assigned(pVideoWindow) then pVideoWindow := nil;
  if Assigned(pMediaEvent) then pMediaEvent := nil;
  if Assigned(pMediaControl) then pMediaControl := nil;
  if Assigned(pGraphBuilder) then pGraphBuilder := nil;
//ïîëó÷àåì èíòåðôåéñ ïîñòðîåíèÿ ãðàôà
  hr := CoCreateInstance(CLSID_FilterGraph, nil, CLSCTX_INPROC_SERVER, IID_IGraphBuilder, pGraphBuilder);
  if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ñîçäàòü ãðàô');
    exit;
  end;
//ïîëó÷àåì èíòåðôåéñ óïðàâëåíèÿ
  hr := pGraphBuilder.QueryInterface(IID_IMediaControl, pMediaControl);
  if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ïîëó÷èòü èíòåðôåéñ IMediaControl');
    exit;
  end;
//ïîëó÷àåì èíòåðôåéñ ñîáûòèé
   hr := pGraphBuilder.QueryInterface(IID_IMediaEvent, pMediaEvent);
   if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ïîëó÷èòü èíòåðôåéñ ñîáûòèé');
    exit;
  end;
//ïîëó÷àåì èíòåðôåéñ óïðàâëåíèÿ îêíîì âûâîäà âèäåî
  hr := pGraphBuilder.QueryInterface(IID_IVideoWindow, pVideoWindow);
  if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ïîëó÷èòü IVideoWindow');
    exit;
  end;
//ïîëó÷àåì èíòåðôåéñ óïðàâëåíèÿ çâóêîì
   hr := pGraphBuilder.QueryInterface(IBasicAudio, pBasicAudio);
  if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ïîëó÷èòü àóäèî èíòåðôåéñ');
    exit;
  end;
//ïîëó÷àåì èíòåðôåéñ  óïðàâëåíèÿ ïîçèöèåé ïðîèãðûâàíèÿ
  hr := pGraphBuilder.QueryInterface(IID_IMediaPosition, pMediaPosition);
   if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ïîëó÷èòü èíòåðôåéñ óïðàâëåíèÿ ïîçèöèåé');
    exit;
  end;
//çàãðóæàåì ôàéë äëÿ ïðîèãðûâàíèÿ
  hr := pGraphBuilder.RenderFile(StringToOleStr(PChar(filename)), '');
  if hr<>0 then begin
    ShowMessage('Íå óäàåòñÿ ïðîðåíäåðèòü ôàéë');
    exit;
  end;

//ðàñïîëàãàåì îêîøêî ñ âèäåî íà ïàíåëü
   pVideoWindow.Put_Owner(Panel1.Handle);//Óñòàíàâëèâàåì "âëàäåëüöà" îêíà, â íàøåì ñëó÷àå Panel1
   pVideoWindow.Put_WindowStyle(WS_CHILD OR WS_CLIPSIBLINGS);//Ñòèëü îêíà
   pVideoWindow.put_MessageDrain(Panel1.Handle);//óêàçûâàåì ÷òî Panel1 áóäåò ïîëó÷àòü ñîîáùåíèÿ âèäåî îêíà
   pVideoWindow.SetWindowPosition(0,0,Panel1.ClientRect.Right,Panel1.ClientRect.Bottom); //ðàçìåðû
end;


procedure Tvideo_form.Player;
//ïðîöåäóðà ïðîèãðûâàíèÿ ôàéëà
begin
if mode<>paused then begin
//ïðîâåðÿåì ñóùåñòâóåò ëè ôàéë çàãðóæàåìûé èç PlayList
//åñëè ôàéë íå ñóùåñòâóåò, òî âûõîäèì
if not FileExists(FileName) then begin ShowMessage('Ôàéë íå ñóùåñòâóåò');exit;end;
//îñâîáîæäàåì êàíàë âîñïðîèçâåäåíèÿ
Initializ;
end;
//Çàïóñêàåì ïðîöåäóðó ïðîèãðûâàíèÿ
pMediaControl.Run;
//ïîëó÷àåì ñêîðîñòü âðñïðîèçâåäåíèÿ
pMediaPosition.get_Rate(Rate);
//ïðèñâàåâàåì çàãîëîâêó ôîðìû èìÿ ïðîèãðûâàåìîãî ôàéëà
video_form.Caption:=ExtractFileName(FileName);
//Óñòàíàâëèâàåì ðåæèì âîñïðîèçâåäåíèÿ PlayMode - play
mode:=play;
end;


Procedure  Tvideo_form.WMKeyDown(Var Msg:TWMKeyDown);
//âûõîä èç ïîëíîýêðàííîãî ðåæèìà ïî êíîïêå ESC
begin
  if Msg.CharCode=VK_ESCAPE then
  begin
      pVideoWindow.HideCursor(False); //ïîêàçûâàåì êóðñîð
      //ïîêàçûâàåì ïëåéëèñò, ñïëèòòåð, ïàíåëü óïðàâëåíèÿ GroupBox
      video_form.ListBox2.Visible:=True;
      video_form.Splitter1.Visible:=True;
      //video_form.CheckBox1.Checked:=True;
      video_form.GroupBox1.Visible:=True;
      //óñòàíàâëèâàåì èñõîäíûå ïàðàìåòðû îêíà
      video_form.BorderStyle:=bsSizeable;
      video_form.windowState:= wsNormal;
      video_form.FormStyle:=fsNormal;
      //çàäàåì ðàçìåðû îêíà âûâîäà
      pVideoWindow.SetWindowPosition(0,0,Panel1.ClientRect.Right,Panel1.ClientRect.Bottom);
      FullScreen:=False;
end;
  inherited;
end;

//ïðîöåäóðà çóãðóçêè ôàéëîâ â ïëåéëèñò
procedure Tvideo_form.AddPlayList;
var
 j: Integer;
begin
OpenDialog1.Options:=[ofHideReadOnly,ofAllowMultiSelect,ofEnableSizing];
OpenDialog1.Title  := 'Îòêðûòèå ôàéëîâ';
//ôèëüòð äëÿ ôàéëîâ
OpenDialog1.Filter := 'Ôàéëû ìóëüòèìåäèà |*.mp3;*.wma;*.wav;*.vob;*.avi;*.mpg;*.mp4;*.mov;*.mpeg;*.flv;*.wmv;*.qt;|Âñå ôàéëû|*.*';
//ïðîâåðÿåì åñëè PlayList íå ïóñòîé òî çàïîìèíàåì íîìåð òåêóùåé çàïèñè
//èíà÷å óñòàíàâëèâàåì íîìåð çàïèñè 0 (ïåðâàÿ ïîçèöèÿ â PlayList)
if listbox2.Count<>0 then i:=ListBox2.ItemIndex else i:=0;
//Äèàëîã îòêðûòèÿ ôàéëà
if not OpenDialog1.Execute then exit;
  Begin
   For j:=0 to OpenDialog1.Files.Count -1 do
    Begin
      ListBox2.Items.Add(ExtractFileName(OpenDialog1.Files.Strings[j]));
      ListBox1.Items.Add(OpenDialog1.Files.Strings[j]);
    End;
  End;
     //çàïîìèíàåì èìÿ ôàéëà òåêóùåé çàïèñè â ïëåéëèñòå
     Filename:=ListBox1.Items.Strings[i];
     //Âûäåëÿåì ýòó çàïèñü â PlayList
     ListBox1.ItemIndex:=i;
     ListBox2.ItemIndex:=i;
end;


//procedure Tvideo_form.CheckBox1Click(Sender: TObject);
////ïîêàçûâàåì èëè ñêðûâàåì ïëåéëèñò
//begin
//if video_form.CheckBox1.Checked=True then
//                                      begin
//                                         video_form.ListBox2.Visible:=True;
//                                         video_form.Splitter1.Visible:=True;
//                                      end
//                                else  begin
//                                         video_form.ListBox2.Visible:=False;
//                                         video_form.Splitter1.Visible:=False;
//                                      end;
//end;

procedure Tvideo_form.Close_labelClick(Sender: TObject);
begin
  video_form.Close;
end;

procedure Tvideo_form.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if mode=play then
    begin
      pMediaControl.Stop;
      mode:=Stop;//óñòàíàâëèâàåì playmode -> ñòîï
      pMediaPosition.put_CurrentPosition(0);
      form2.MediaPlayer1.Play;
    end;
  //form2.MediaPlayer1.Play;
end;

procedure Tvideo_form.FormCreate(Sender: TObject);
begin
  video_form.Visible:=false;
  image9.left:=main_panel.Width-170;
  image8.left:=main_panel.Width-60;
  //  main_image.Canvas.Pen.Color:=clBlack;
  //main_image.FrameRect(0,0,Image1.Width,Image1.Height);
  video_form.Brush.Style := bsClear;
  video_form.BorderStyle := bsNone;
// ýòè äâå ñêûâàþò âñå, íî ôîðìà êàê áûëà òàê è åñòü, õîòü è íå âèäíî.
  video_form.TransparentColorValue := clblue;
  video_form.transparentcolor := true;
  video_form.Color := clblue;
// ýòè òðè ñêðûâàþò ñàìó ôîðìó, òåïåðü ïðÿì çà êíîïêàìè ìîæíî ïðîèçâîäèòü äåéñòâèÿ
  CoInitialize(nil);// èíèöèàëèçèðîâàòü OLE
end;

procedure Tvideo_form.FormDestroy(Sender: TObject);
begin
  CoUninitialize;// äåèíèöèàëèçèðîâàòü OLE
end;

procedure Tvideo_form.FormMouseWheelDown(Sender: TObject; Shift: TShiftState;
  MousePos: TPoint; var Handled: Boolean);
begin
  image9.left:=main_panel.Width-170;
  image8.left:=main_panel.Width-60;
  video_form.width:=video_form.width-10;
  video_form.Height:=ceil(video_form.width*0.6875);
  main_panel.width:=main_panel.width-10;
  main_panel.Height:=ceil(main_panel.width*0.5875);
end;

procedure Tvideo_form.FormMouseWheelUp(Sender: TObject; Shift: TShiftState;
  MousePos: TPoint; var Handled: Boolean);
begin
  image9.left:=main_panel.Width-170;
  image8.left:=main_panel.Width-60;
  video_form.width:=video_form.width+10;
  video_form.Height:=ceil(video_form.width*0.6875);
  main_panel.width:=main_panel.width+10;
  main_panel.Height:=ceil(main_panel.width*0.5875);
end;

procedure Tvideo_form.ListBox2Click(Sender: TObject);
begin
  //óñòàíàâëèâàåì îäèíàêîâóþ ïîçèöèþ â ïëåéëèñòàõ ïðè âûáîðå
  i:=ListBox2.Itemindex;
  ListBox1.Itemindex:=i;
end;

procedure Tvideo_form.ListBox2DblClick(Sender: TObject);
begin
  //âûáèðàåì ôàéë èç ïëåéëèñòà ïðè äâîéíîì êëèêå äëÿ âîñïðîèçâåäåíèÿ
  i:=ListBox2.Itemindex;
  ListBox1.Itemindex:=i;
  Filename:=ListBox1.Items.Strings[i];
  mode:=stop;
  //âûçûâàåì ïðîöåäóðó ïðîèãðûâàíèÿ ôàéëà
  player;
end;

//ïðîöåäóðà âûçîâà PopupMenu ïðè íàæàòèè ïðàâîé êíîïêîé ìûøè íà ïëåéëèñòå (ListBox)
procedure Tvideo_form.ListBox2MouseActivate(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y, HitTest: Integer;
  var MouseActivate: TMouseActivate);
var
point : TPoint;
begin
  if (Button = mbRight) then
  // íàæàòà ïðàâàÿ ìûøü
  begin
    point.X := X;
    point.Y := Y;
    i := ListBox2.ItemAtPos(point, true);
    // âûäåëÿåì ñòðîêó
    ListBox1.ItemIndex:=i;
    ListBox2.ItemIndex:=i;
      if i >= 0 then
    // åñëè ùåëêíóëè ïî ïîëÿì ñïèñêà
    begin
    // ïîäíèìàåì ìåíþ
     PopupMenu1.Popup(ListBox2.ClientOrigin.X + X, ListBox2.ClientOrigin.Y + Y);
    end;
end;
end;

//ïðîöåäóðà óäàëåíèÿ çàïèñåé â ïëåéëèñòå
procedure Tvideo_form.N1Click(Sender: TObject);
begin
//î÷èñòêà ïëåéëèñòà
ListBox1.Clear;
ListBox2.Clear;
end;

procedure Tvideo_form.N2Click(Sender: TObject);
//óäàëåíèå çàïèñè
begin
ListBox1.DeleteSelected;
ListBox2.DeleteSelected;
end;

procedure Tvideo_form.N3Click(Sender: TObject);
begin
//âûçûâàåì ïðîöåäóðó çàãðóçêè ïëåéëèñòà
  AddPlayList;
end;

//Ïðîöåäóðà ïåðåõîäà â ïîëíîýêðàííûé ðåæèì è îáðàòíî
procedure Tvideo_form.Panel1DblClick(Sender: TObject);
var
Rct: TRect;
begin
if hr <> 0 then exit; //åñëè ôàéë íå çàãðóæåí âûõîäèì
pVideoWindow.HideCursor(False); //ïîêàçûâàåì êóðñîð
if FullScreen=False then begin
//ñêðûâàåì ïëåéëèñò, ñïëèòòåð è ïàíåëü óïðàâëåíèÿ
video_form.ListBox2.Visible:=False;
video_form.Splitter1.Visible:=false;
video_form.GroupBox1.Visible:=false;
//óñòàíàâëèâàåì ïàðàìåòðû ôîðìû
video_form.BorderStyle:=bsNone; //áåç áîðäþðà
video_form.FormStyle :=fsstayOnTop; //ïîâåðõ îêîí
video_form.windowState:= wsMaximized;// íà âåñü ýêðàí
//óñòàíàâëèâàåì âûâîä âèäåî íà âñþ øèðèíó ýêðàíà
pVideoWindow.SetWindowPosition(0,0,screen.Width,screen.Height);
FullScreen:=True;
end
else begin
// âîññòàíàâëèâàåì çíà÷åíèÿ ïðè âûõîäå èç ïîëíîýêðàííîãî ðåæèìà
//if form1.CheckBox1.Checked=true then  video_form.ListBox2.Visible:=True;
video_form.GroupBox1.Visible:=True;
video_form.Splitter1.Visible:=True;
video_form.BorderStyle:=bsSizeable;
video_form.windowState:= wsNormal;
video_form.FormStyle:=fsNormal;
pVideoWindow.SetWindowPosition(0,0,Panel1.ClientRect.Right,Panel1.ClientRect.Bottom);
FullScreen:=False;
end;
end;

//ïðîöåäóðà ïîêàçûâàíèÿ ïëåéëèñòà è ïàíåëè óïðàâëåíèÿ ïðè íàâåäåíèè íà íèõ ìûøè
procedure Tvideo_form.Panel1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
//âûõîäèì åñëè ðåæèì íå ïîëíîýêðàííûé
if FullScreen<>True then Exit;
//ñêðûâàåì ïëåéëèñò åñëè êóðñîð ìûøè ñ íåãî óõîäèò
if (mouse.CursorPos.X<panel1.Width) and (ListBox2.Visible=True) then
begin
video_form.ListBox2.Visible:=False;
video_form.Splitter1.Visible:=False;
end;
//ïîêàçûâàåì ïëåéëèñò ïðè íàâåäåíèè íà åãî ïîëîæåíèå ìûøè, åñëè îí áûë âêëþ÷åí
if (mouse.CursorPos.X>=panel1.Width-ListBox2.Width) and (ListBox2.Visible=False) then
begin
//if form1.CheckBox1.Checked=true then
//  begin
//    video_form.ListBox2.Visible:=True;
//    video_form.Splitter1.Visible:=True;
//  end;
end;

//àíàëîãè÷íî ñ ïàíåëüþ óïðàëåíèåì ïðîèãðûâàíèåì
if (mouse.CursorPos.Y<panel1.Height) and (groupbox1.Visible=True) then
begin
groupbox1.Visible:=false;
end;

if (mouse.CursorPos.Y>=panel1.Height-groupbox1.Height) and (groupbox1.Visible=False) then
begin
groupbox1.Visible:=True;
end;
end;

//Ïðîöåäóðà èçìåíåíèÿ ðàçìåîâ îêíà ïðîèãðûâàíèÿ ïðè èçìåíåíèè ðàçìåðîâ ïàíåëè
procedure Tvideo_form.Panel1Resize(Sender: TObject);
begin
 if mode=play then
 begin
 pVideoWindow.SetWindowPosition(0,0,Panel1.ClientRect.Right,Panel1.ClientRect.Bottom);
end;
end;

//ïðîöåäóðà èçìåíåíèÿ ïîçèöèè ïðîèãðûâàíèÿ ïðè èçìåíåíèè ïîçèöèè ProgressBar (ïåðåìîòêà)
procedure Tvideo_form.ProgressBar1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
var
  p: real;
begin
if hr = 0 then  begin
  if ssleft in shift then //åñëè íàæàòà ëåâàÿ êíîïêà ìûøè
  begin
    p:=ProgressBar1.Max/ProgressBar1.Width;
    ProgressBar1.Position:=round(x*p);
    pMediaControl.Stop;
    pMediaPosition.put_CurrentPosition(ProgressBar1.Position);
    pMediaControl.Run;
    mode:=play;
  end;
end;
end;

//ïðîöåäóðà âîñïðîèçâåäåíèÿ
procedure Tvideo_form.SpeedButton1Click(Sender: TObject);
begin
  //Ïðîâåðÿåì åñëè âîñïðîèçâåäåíèå óæå èäåò òî óñòàíàâëèâàåì
  //íîðìàëüíóþ ñêîðîñòü âîñïðîèçâåäåíèÿ è âûõîäèì
    if mode=play then
    begin
      image1.Tag:=1;
      pMediaPosition.put_Rate(Rate);
      exit;
    end;
    Player;
end;

//ïðîöåäóðà ïàóçû
procedure Tvideo_form.SpeedButton2Click(Sender: TObject);
begin
 //Ïðîâåðÿåì èäåò ëè âîñïðîèçâåäåíèå
 if mode=play then
 begin
   pMediaControl.Pause;
   mode:=paused;//óñòàíàâëèâàåì playmode -> ïàóçà
 end;
end;

//ïðîöåäóðà îñòàíîâêè
procedure Tvideo_form.SpeedButton3Click(Sender: TObject);
begin
//Ïðîâåðÿåì èäåò ëè âîñïðîèçâåäåíèå
 if mode=play then
 begin
   pMediaControl.Stop;
   mode:=Stop;//óñòàíàâëèâàåì playmode -> ñòîï
   //çàäàåì íà÷àëüíîå ïîëîæåíèå ïðîèãðàâàíèÿ
   pMediaPosition.put_CurrentPosition(0);
 end;
end;

//ïðîöåäóðà çàìåäëåííîãî âîñïðîèçâåäåíèÿ
procedure Tvideo_form.SpeedButton4Click(Sender: TObject);
var  pdRate: Double;
begin
if mode=play then
  begin
   if ProgressBar1.Position>=15 then pMediaPosition.put_CurrentPosition(ProgressBar1.Position-15);
  end;
end;

//ïðîöåäóðà óñêîðåííîãî âîñïðîèçâåäåíèÿ
procedure Tvideo_form.SpeedButton5Click(Sender: TObject);
var  pdRate: Double;
begin
if mode=play then
  begin
    if ProgressBar1.Position+15<=ProgressBar1.Max then pMediaPosition.put_CurrentPosition(ProgressBar1.Position+15);
  end;
end;


procedure Tvideo_form.SpeedButton6Click(Sender: TObject);
begin
  Form2.WindowState:=wsMinimized;
  AddPlayList;
  Form2.WindowState:=wsNormal;
  video_form.SetFocus;
end;


procedure Tvideo_form.timTimer(Sender: TObject);
var
TrackLen, TrackPos: Double;
ValPos: Double;
ValLen: Double;
plVolume:Longint;
db  : integer;
begin
//âûâîäèì âðåìÿ
//Panel4.Caption:=TimeToStr(SysUtils.Time);
//ïðîâåðÿåì ðåæèì âîñïðîèçâåäåíèÿ, åñëè íå Play òî âûõîäèì
if hr <> 0 then Exit;
//âðåìÿ ïðîèãðûâàíèÿ ôèëüìà
//ñ÷èòûâàåì âñþ äëèíó ôèëüìà â ñåêóíäàõ
pMediaPosition.get_Duration(pDuration);
//çàäàåì ìàêñèìàëüíîå ïîëîæåíèå ProgressBar
ProgressBar1.Max:=round(pDuration);
//ñ÷èòàâàåì ñêîëüêî ñåêóíä ïðîøëî îò íà÷àëà âîñïðîèçâåäåíèÿ
pMediaPosition.get_CurrentPosition(pCurrent);
//çàäàåì òåêóùåå ïîëîæåíèå ProgressBar
ProgressBar1.Position:=round(pCurrent);
 //âîñïðîèçâåäåíèå ñëåäóþùåãî ôèëüìà
//åñëè âðåìÿ ïðîèãðûâàíèÿ ðàâíî äëèíå ôèëüìà ïî âðåìåíè,
if pCurrent=pDuration then
begin
//òî âûáèðàåì ñëåäóþùóþ çàïèñü èç ïëåéëèñòà
if i<ListBox2.Items.Count-1 then
   begin
     inc(i);
     Filename:=ListBox1.Items.Strings[i];
     ListBox1.ItemIndex:=i;
     ListBox2.ItemIndex:=i;
     mode:=stop;
     player;
   end
//åñëè ëèñò çàêîí÷èëñÿ - âûõîäèì
   else exit;
end;

//Óñòàíîâêà ãðîìêîñòè, ãðîìêîñòü çàäàåòñÿ îò -10000 äî 0
//ê ñîæåëåíèþ ïðè òàêîì ðåãóëèðîâàíèè çâóê íà÷èíàåò çàìåòíî ïðèáàâëÿòüñÿ òîëüêî â êîíöå øêàëû
//pBasicAudio.put_Volume(TrackBar1.Position*100-10000);

//åùå îäèí âàðèàíò ðåãóëèðîâàíèÿ ãðîìêîñòè. Áîëåå ïëàâíîå ðåãóëèðîâàíèå çâóêà
plVolume:= (65535 * TrackBar1.Position) div 100;
//íîðìèðóåì õàðàêòåðèñòèêó óðîâíÿ ãðîìêîñòè
db:= trunc(33.22 * 100 * ln((plVolume+1e-6)/65535)/ln(10));
pBasicAudio.put_Volume(db);


//äåëàåì âû÷èñëåíèå âðåìåíè
TrackLen:=pDuration;
TrackPos:=pCurrent;
//ïåðåâîäèì ñåêóíäû â ÷àñû
ValPos:=TrackPos / (24 * 3600);
ValLen:=TrackLen / (24 * 3600);
//Âûâîäèì äàííûå î âðåìåíè íà ôîðìó â Label1 è Label2
Label2.Caption:=FormatDateTime('hh:mm:ss',ValPos);
Label3.Caption:=FormatDateTime('hh:mm:ss',ValLen);
end;

//ïðîöåäóðà ñêðûòèÿ êóðñîðà â ïîëíîýêðàííîì ðåæèìå
procedure Tvideo_form.Timer2Timer(Sender: TObject);
begin
if FullScreen<>True then Exit;
//ïðîâåðÿåì ïîëîæåíèå êóðñîðà è åñëè îí íå îòêëîíèëñÿ
//îò ñâîåãî ïîëîæåíèÿ áîëüøå ÷åì íà ïÿòü òî÷åê, òî ñêðûâàåì êóðñîð èíà÷å ïîêàçûâàåì
if ((xn-5)<=mouse.CursorPos.X) and ((yn-5)<=mouse.CursorPos.Y) and ((xn+5)>=mouse.CursorPos.X) and ((yn+5)>=mouse.CursorPos.Y)then
pVideoWindow.HideCursor(true)  else pVideoWindow.HideCursor(False);
//çàïîìèíàåì êîîðäèíàòû êóðñîðà
xn:=mouse.CursorPos.X;
yn:=mouse.CursorPos.Y;
end;

procedure Tvideo_form.Timer_formTimer(Sender: TObject);
begin
  video_form.Visible:=true;
  video_form.AlphaBlendValue:= video_form.AlphaBlendValue+5;
  if video_form.AlphaBlendValue>=250 then
  begin
    timer_form.Destroy;
    //ideo_form.AlphaBlendValue:=0;
    exit;
  end;

end;

end.
